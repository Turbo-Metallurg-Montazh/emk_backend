name: Deploy Backend to Kindred VPS

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------- TAGGING -------------------

      - name: Get latest tag
        id: get_tag
        run: |
          tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump
        run: |
          tag="${{ steps.get_tag.outputs.tag }}"
          clean_tag="${tag#v}"
          IFS='.' read -r major minor patch <<<"$clean_tag"
          patch=$((patch+1))
          new_tag="v$major.$minor.$patch"
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

      - name: Create and push new tag
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin ${{ steps.bump.outputs.new_tag }}

      # -------- BUILD & PUSH DOCKER IMAGES ---------

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'

      - name: Set lowercase owner
        id: repo_owner
        run: echo "owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build Docker
        run: |
          docker build \
            -t ghcr.io/${{ steps.repo_owner.outputs.owner }}/emk-backend:${{ steps.bump.outputs.new_tag }} \
            -t ghcr.io/${{ steps.repo_owner.outputs.owner }}/emk-backend:latest \
            .

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Push Docker images
        run: |
          docker push ghcr.io/${{ steps.repo_owner.outputs.owner }}/emk-backend:${{ steps.bump.outputs.new_tag }}
          docker push ghcr.io/${{ steps.repo_owner.outputs.owner }}/emk-backend:latest

      # -------- COPY FILES TO SERVER ---------

      - name: Copy compose & nginx
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: |
            docker-compose.prod.yml
            nginx.conf
          target: /home/${{ secrets.VPS_USER }}/emk/emk_crm_backend

      # -------- BLUE-GREEN DEPLOY ON VPS ---------

      - name: Blue-Green deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/emk_prod
            echo "BACKEND_TAG=${{ steps.bump.outputs.new_tag }}" > .env.prod
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env.prod
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.prod

            # read current version
            if [ -f current_version ]; then
              prev=$(cat current_version)
              echo $prev > previous_version
            fi

            echo "${{ steps.bump.outputs.new_tag }}" > current_version

            # Deploy new version
            docker compose --env-file .env.prod pull
            docker compose --env-file .env.prod up -d

            # Basic healthcheck
            sleep 5
            if curl -f http://localhost:80/actuator/health; then
              echo "New version OK"
            else
              echo "Healthcheck FAILED ‚Äì performing rollback..."
              old=$(cat previous_version)
              echo "BACKEND_TAG=$old" > .env.prod
              docker compose --env-file .env.prod pull
              docker compose --env-file .env.prod up -d
              exit 1
            fi

      # -------- TELEGRAM NOTIFICATIONS ---------

      - name: Send success message
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üöÄ Deploy successful! Version: ${{ steps.bump.outputs.new_tag }}"

      - name: Send failure message
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚ùå Deploy FAILED! Rolled back to previous version."